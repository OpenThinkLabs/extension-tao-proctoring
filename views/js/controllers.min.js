define("taoProctoring/controller/routes",{Reporting:{actions:{index:"controller/Reporting/history"}},Irregularity:{actions:{index:"controller/Irregularity/index"}},DeliverySelection:{actions:{index:"controller/Delivery/index"}},Monitor:{actions:{index:"controller/Delivery/monitoring"}},Tools:{actions:{pauseActiveExecutions:"controller/Tools/pauseActiveExecutions"}}}),define("controller/app",["jquery","core/historyRouter","core/logger","core/eventifier","core/statifier","util/url","ui/feedback"],function($,historyRouterFactory,loggerFactory,eventifier,statifier,urlUtil,feedback){"use strict";var historyRouter,appLogger=loggerFactory("controller/app"),appController=eventifier(statifier({
start:function(options){var currentRoute;appController.apply(),currentRoute=options&&options.forwardTo?options.forwardTo:window.location+"",historyRouter.forward(currentRoute)},apply:function(selector,target){return selector=selector||".router",target=target||document,$(target).off("click.appController").on("click.appController",selector,function(e){var $elt,href;e.preventDefault(),$elt=$(this),href=$elt.attr("href"),href||(href=$("[href]:first-child",$elt).attr("href")),href&&historyRouter.redirect(href)}),this},getRouter:function(){return historyRouter},getLogger:function(){return appLogger},onError:function(err){var message=err&&err.message||err;return appLogger.error(err),
feedback().error(message),this}}));return historyRouter=historyRouterFactory().on("dispatching",function(url){appController.setState("dispatching"),appController.trigger("change",url)}).on("dispatched",function(url){appController.setState("dispatching",!1),appController.trigger("started",url)}),appController}),define("taoProctoring/helper/status",["lodash","i18n"],function(_,__){"use strict";function getStatus(statusName){return _status[statusName]}function getStatusByCode(statusCode){return _.find(_status,{code:statusCode})}function verifyTestTaker(testTakerData,actionName){var formatted={id:testTakerData.id,label:testTakerData.firstname+" "+testTakerData.lastname
},status=_status.getStatusByCode(testTakerData.state.status);return status&&(formatted.allowed=status.can[actionName]===!0,formatted.allowed||(formatted.reason=status.can[actionName])),formatted}function getStatuses(){return _.map(_status,function(el){return{code:el.code,label:el.label}})}var _awaiting="http://www.tao.lu/Ontologies/TAODelivery.rdf#DeliveryExecutionStatusAwaiting",_authorized="http://www.tao.lu/Ontologies/TAODelivery.rdf#DeliveryExecutionStatusAuthorized",_inprogress="http://www.tao.lu/Ontologies/TAODelivery.rdf#DeliveryExecutionStatusActive",_paused="http://www.tao.lu/Ontologies/TAODelivery.rdf#DeliveryExecutionStatusPaused",_completed="http://www.tao.lu/Ontologies/TAODelivery.rdf#DeliveryExecutionStatusFinished",_terminated="http://www.tao.lu/Ontologies/TAODelivery.rdf#DeliveryExecutionStatusTerminated",_canceled="http://www.tao.lu/Ontologies/TAODelivery.rdf#DeliveryExecutionStatusCanceled",_status={
inprogress:{code:_inprogress,label:__("In Progress"),can:{authorize:__("already authorized"),pause:!0,terminate:!0,report:!0,print:__("not finished"),time:!0}},authorized:{code:_authorized,label:__("Authorized but not started"),can:{authorize:__("already authorized"),terminate:!0,report:!0,pause:__("not started"),print:__("not finished"),time:!0}},awaiting:{code:_awaiting,label:__("Awaiting"),can:{authorize:!0,pause:__("not in progress"),terminate:!0,report:!0,print:__("not finished"),time:!0}},canceled:{code:_canceled,label:__("Canceled"),can:{authorize:__("is canceled"),pause:__("is canceled"),terminate:__("is canceled"),report:!0,print:__("is canceled"),time:!0
}},completed:{code:_completed,label:__("Completed"),can:{authorize:__("is completed"),pause:__("is completed"),terminate:__("is completed"),report:!0,print:!0,time:!0}},paused:{code:_paused,label:__("Paused"),can:{authorize:__("is paused"),pause:__("is already paused"),terminate:!0,report:!0,print:__("not finished"),time:!0}},terminated:{code:_terminated,label:__("Terminated"),can:{authorize:__("is terminated"),pause:__("is terminated"),terminate:__("is terminated"),report:!0,print:!0,time:!0}}};return{getStatuses:getStatuses,getStatus:getStatus,getStatusByCode:getStatusByCode,verifyTestTaker:verifyTestTaker,STATUS_AUTHORIZED:_authorized,STATUS_INPROGRESS:_inprogress,
STATUS_PAUSED:_paused,STATUS_COMPLETED:_completed,STATUS_TERMINATED:_terminated}}),define("taoProctoring/component/proxy",["core/dataProvider/proxy","core/dataProvider/proxy/ajax"],function(proxyFactory,ajaxProxy){"use strict";return proxyFactory.registerProvider("ajax",ajaxProxy)}),define("tpl!taoProctoring/templates/delivery/index",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var stack1,helper,buffer="";return buffer+="<h1>",(helper=helpers.title)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.title,stack1=typeof helper===functionType?helper.call(depth0,{
hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</h1>"}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,buffer="",functionType="function",escapeExpression=this.escapeExpression,self=this;return buffer+='<div class="content">\n    ',stack1=helpers.if.call(depth0,depth0&&depth0.title,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+='\n    <div class="panel"></div>\n    <div class="list clearfix"></div>\n</div>\n'})}),define("tpl!taoProctoring/templates/delivery/listBoxActions",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){
this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",functionType="function",escapeExpression=this.escapeExpression,helperMissing=helpers.helperMissing;return buffer+='<span class="listbox-actions">\n    <span class="action pause" data-delivery="',(helper=helpers.id)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.id,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'">\n        <span class="icon-pause"></span>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Pause",options):helperMissing.call(depth0,"__","Pause",options)))+'\n    </span>\n    <span class="action play">\n        <span class="icon-play"></span>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,
options={hash:{},data:data},helper?helper.call(depth0,"Monitor",options):helperMissing.call(depth0,"__","Monitor",options)))+"\n    </span>\n</span>"})}),define("tpl!taoProctoring/templates/delivery/listBoxStats",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var stack1,helper,options,buffer="";return buffer+='\n<ul class="plain listbox-properties">\n    <li>\n        <label>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Start",options):helperMissing.call(depth0,"__","Start",options)))+"</label>: ",(helper=helpers.periodStart)?stack1=helper.call(depth0,{
hash:{},data:data}):(helper=depth0&&depth0.periodStart,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\n    </li>\n    <li>\n        <label>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"End",options):helperMissing.call(depth0,"__","End",options)))+"</label>: ",(helper=helpers.periodEnd)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.periodEnd,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"\n    </li>\n</ul>\n"}this.compilerInfo=[4,">= 1.0.0"],
helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression,functionType="function",self=this;return stack1=helpers.if.call(depth0,depth0&&depth0.showProperties,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+='\n<p class="listbox-stats">\n    <span class="icon-lock"></span><span class="number">',(helper=helpers.locked)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.locked,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'</span>\n    <span class="icon-play"></span><span class="number">',
(helper=helpers.inProgress)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.inProgress,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'</span>\n    <span class="icon-pause"></span><span class="number">',(helper=helpers.paused)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.paused,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n</p>"})}),define("taoProctoring/controller/Delivery/index",["jquery","lodash","i18n","core/promise","controller/app","util/url","layout/loading-bar","ui/listbox","util/encode","ui/feedback","ui/bulkActionPopup","ui/cascadingComboBox","ui/container","taoProctoring/helper/status","taoProctoring/component/proxy","tpl!taoProctoring/templates/delivery/index","tpl!taoProctoring/templates/delivery/listBoxActions","tpl!taoProctoring/templates/delivery/listBoxStats"],function($,_,__,Promise,appController,urlHelper,loadingBar,listBoxFactory,encode,feedback,bulkActionPopup,cascadingComboBox,containerFactory,_status,proxyFactory,indexTpl,actionsTpl,statsTpl){
"use strict";function handleOnDisconnect(err){403===err.code&&window.location.reload(!0)}function getSessionsNames(sessions){return _.map(sessions,function(session){var testTaker=session.testTaker;return{id:session.id,label:testTaker.firstName+" "+testTaker.lastName}})}function validateParams(params){return _.isPlainObject(params)&&(_.isUndefined(params.delivery)||!_.isEmpty(params.delivery))&&(_.isUndefined(params.execution)||!_.isEmpty(params.execution))&&(_.isUndefined(params.reason)||!_.isEmpty(params.reason))}var cssScope=".delivery-index",serviceUrl=urlHelper.route("deliveries","DeliverySelection","taoProctoring"),pauseUrl=urlHelper.route("pauseExecutions","Monitor","taoProctoring"),sessionsUrl=urlHelper.route("deliveryExecutions","Monitor","taoProctoring");
return loadingBar.start(),{start:function(){var deliveries,categories,proxyDeliveries,proxySessions,title=__("Sessions"),container=containerFactory(".container").changeScope(cssScope).write(indexTpl({title:title})),listBox=listBoxFactory({title:title,textEmpty:__("No sessions available"),textNumber:__("Available"),textLoading:__("Loading"),renderTo:container.find(".content"),replace:!0,list:[],width:12,countRenderer:function(count){return count-1}});appController.on("change.deliveryIndex",function(){appController.off(".deliveryIndex"),listBox.destroy(),container.destroy()}),Promise.all([proxyFactory("ajax").init({actions:{read:serviceUrl}}).then(function(proxy){
proxyDeliveries=proxy}),proxyFactory("ajax").init({actions:{read:{url:sessionsUrl,validate:validateParams},pause:{url:pauseUrl,validate:validateParams}}}).then(function(proxy){proxySessions=proxy})]).then(function(){function getDeliveryLabel(id){return deliveries[id]&&deliveries[id].label}function formatPauseWarning(response,deliveryExecutions){var messageContext,unprocessed,responseData;return messageContext="",response&&(responseData=response.data,unprocessed={},responseData&&_.forEach(responseData.unprocessed,function(id){var execution=deliveryExecutions[id],uri=execution&&execution.delivery&&execution.delivery.uri;uri&&(unprocessed[uri]=(unprocessed[uri]||0)+1);
}),unprocessed=_.map(unprocessed,function(count,uri){return count>1?__("%d sessions of the delivery %s have not been paused",count,getDeliveryLabel(uri)):__("A session of the delivery %s have not been paused",getDeliveryLabel(uri))}),unprocessed.length&&(messageContext+="<br>"+unprocessed.join("<br>")),response.error&&(messageContext+="<br>"+encode.html(response.error))),messageContext}function refresh(){return loadingBar.start(),listBox.setLoading(!0),proxyDeliveries.read().then(function(data){categories=data.categories,deliveries=_.transform(data.list,function(result,delivery){var props=delivery.properties,tplData={locked:delivery.stats.awaitingApproval,inProgress:delivery.stats.inProgress,
paused:delivery.stats.paused};props&&props.periodStart&&props.periodEnd&&(tplData.showProperties=!0,tplData.periodStart=props.periodStart,tplData.periodEnd=props.periodEnd,delivery.cls="has-properties-displayed"),delivery.html=actionsTpl({id:delivery.id}),delivery.content=statsTpl(tplData),delivery.cls=((delivery.cls||"")+" router").trim(),result[delivery.id]=delivery},{}),listBox.update(data.list),loadingBar.stop()}).catch(function(err){handleOnDisconnect(err),appController.onError(err)})}function pause(deliveryId,selection,deliveryExecutions){return new Promise(function(resolve,reject){bulkActionPopup({renderTo:container.getElement(),actionName:__("Pause Session"),
reason:!0,resourceType:"test taker",categoriesSelector:cascadingComboBox({categoriesDefinitions:categories.pause.categoriesDefinitions,categories:categories.pause.categories}),allowedResources:getSessionsNames(selection)}).on("cancel",resolve).on("ok",function(reason){proxySessions.action("pause",{delivery:deliveryId,execution:_.pluck(selection,"id"),reason:reason}).then(function(){feedback().success("Selected deliveries successfully paused"),refresh().then(resolve).catch(reject)}).catch(function(err){err.response?(feedback().warning(__("Something went wrong ...")+"<br>"+formatPauseWarning(err.response,deliveryExecutions),{encodeHtml:!1}),resolve()):reject(err);
})})})}listBox.getElement().on("click",".pause",function(e){var deliveryId=$(this).data("delivery");loadingBar.start(),e.stopPropagation(),e.preventDefault(),proxySessions.read({delivery:deliveryId}).then(function(sessions){var inProgressExecs,deliveryExecutions={};return inProgressExecs=_.filter(sessions,function(session){return deliveryExecutions[session.id]=session,session.state&&session.state.status===_status.getStatus("inprogress").code}),inProgressExecs.length?pause(deliveryId,inProgressExecs,deliveryExecutions):void feedback().info(__("There is no delivery in progress"))}).catch(function(err){handleOnDisconnect(err),appController.onError(err)}).then(function(){
loadingBar.stop()})}),refresh()}).catch(function(err){handleOnDisconnect(err),appController.onError(err),loadingBar.stop()})}}}),define("taoProctoring/component/breadcrumbs",["ui/breadcrumbs"],function(breadcrumbs){"use strict";return function($container,crumbs){return breadcrumbs({breadcrumbs:crumbs,renderTo:$container.find(".header"),replace:!0,cls:"action-bar horizontal-action-bar"})}}),define("taoProctoring/controller/Delivery/manage",["jquery","i18n","helpers","layout/loading-bar","util/encode","ui/feedback","ui/dialog","taoProctoring/component/breadcrumbs","ui/datatable"],function($,__,helpers,loadingBar,encode,feedback,dialog,breadcrumbsFactory){"use strict";
var cssScope=".delivery-manager";loadingBar.start();var proctorDeliveryIndexCtlr={start:function(){var $container=$(cssScope),$list=$container.find(".list"),crumbs=$container.data("breadcrumbs"),dataset=$container.data("set"),deliveryId=$container.data("delivery"),testCenterId=$container.data("testcenter"),assignUrl=helpers._url("testTakers","Delivery","taoProctoring",{delivery:deliveryId,testCenter:testCenterId}),removeUrl=helpers._url("removeTestTakers","Delivery","taoProctoring",{delivery:deliveryId,testCenter:testCenterId}),serviceUrl=helpers._url("deliveryTestTakers","Delivery","taoProctoring",{delivery:deliveryId,testCenter:testCenterId}),monitoringUrl=helpers._url("monitoring","Delivery","taoProctoring",{
delivery:deliveryId,testCenter:testCenterId}),request=(breadcrumbsFactory($container,crumbs),function(url,selection,message){selection&&selection.length&&(loadingBar.start(),$.ajax({url:url,data:{testtaker:selection},dataType:"json",type:"POST",error:function(){loadingBar.stop()}}).done(function(response){loadingBar.stop(),response&&response.success?(message&&feedback().success(message),$list.datatable("refresh")):feedback().error(__("Something went wrong ...")+"<br>"+encode.html(response.error),{encodeHtml:!1})}))}),remove=function(selection){request(removeUrl,selection,__("Test takers have been removed"))};$list.on("query.datatable",function(){loadingBar.start();
}).on("load.datatable",function(){loadingBar.stop()}).datatable({url:serviceUrl,status:{empty:__("No assigned test takers"),available:__("Assigned test takers"),loading:__("Loading")},tools:[{id:"refresh",icon:"reset",title:__("Refresh the page"),label:__("Refresh"),action:function(){$list.datatable("refresh")}},{id:"back",icon:"preview",title:__("Return to the session monitoring"),label:__("Monitoring"),action:function(){window.location.href=monitoringUrl}},{id:"assign",icon:"add",title:__("Assign more test takers to this session"),label:__("Add test takers"),action:function(){window.location.href=assignUrl}},{id:"remove",icon:"remove",title:__("Remove the selected test takers from the session"),
label:__("Remove"),massAction:!0,action:function(selection){dialog({message:__("The test takers will be removed from this session. Continue ?"),autoRender:!0,autoDestroy:!0,onOkBtn:function(){remove(selection)}})}}],actions:[{id:"remove",icon:"remove",title:__("Remove the test taker from the session"),action:function(id){dialog({autoRender:!0,autoDestroy:!0,message:__("The test taker will be removed from this session. Continue ?"),onOkBtn:function(){remove([id])}})}}],selectable:!0,model:[{id:"firstname",label:__("First name")},{id:"lastname",label:__("Last name")},{id:"identifier",label:__("Identifier")},{id:"status",label:__("Status")}]},dataset)}};return proctorDeliveryIndexCtlr;
}),define("taoProctoring/component/extraTime/encoder",["core/format","core/encoder/time"],function(format,timeEncoder){"use strict";function encodeExtraTime(extraTime,consumedTime,pattern,unit){var encoded="";return pattern=pattern||"%s",unit=unit||1,extraTime&&(encoded=consumedTime?timeEncoder.encode(Math.min(consumedTime,extraTime))+"/"+timeEncoder.encode(extraTime):format(pattern,extraTime/unit),encoded=" +"+encoded),encoded}return encodeExtraTime}),define("tpl!taoProctoring/component/extraTime/extraTime",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var stack1,helper,options,buffer="";
return buffer+='\n    <div class="multiple">\n        <p>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"The action will be applied to the following session",options):helperMissing.call(depth0,"__","The action will be applied to the following session",options)))+':</p>\n        <ul class="plain applicables">\n            ',stack1=helpers.each.call(depth0,depth0&&depth0.allowedResources,{hash:{},inverse:self.noop,fn:self.program(2,program2,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n        </ul>\n    </div>\n\n    ",stack1=helpers.if.call(depth0,(stack1=depth0&&depth0.deniedResources,
null==stack1||stack1===!1?stack1:stack1.length),{hash:{},inverse:self.noop,fn:self.program(7,program7,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n\n    "}function program2(depth0,data){var stack1,helper,buffer="";return buffer+='\n            <li data-resource="',(helper=helpers.id)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.id,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'">\n                <span class="resource-label">',(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1=typeof helper===functionType?helper.call(depth0,{
hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>\n                ",stack1=helpers.if.call(depth0,depth0&&depth0.remainingStr,{hash:{},inverse:self.noop,fn:self.program(3,program3,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n                ",stack1=helpers.if.call(depth0,depth0&&depth0.extraTimeStr,{hash:{},inverse:self.noop,fn:self.program(5,program5,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n            </li>\n            "}function program3(depth0,data){var stack1,helper,buffer="";return buffer+='<span class="remaining">',(helper=helpers.remainingStr)?stack1=helper.call(depth0,{hash:{},data:data
}):(helper=depth0&&depth0.remainingStr,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</span>"}function program5(depth0,data){var stack1,helper,buffer="";return buffer+='<span class="time">(',(helper=helpers.extraTimeStr)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.extraTimeStr,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+")</span>"}function program7(depth0,data){var stack1,helper,options,buffer="";return buffer+="\n    <p>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},
data:data},helper?helper.call(depth0,"However, the action will not be applied to the following sessions",options):helperMissing.call(depth0,"__","However, the action will not be applied to the following sessions",options)))+':</p>\n    <ul class="plain no-applicables">\n        ',stack1=helpers.each.call(depth0,depth0&&depth0.deniedResources,{hash:{},inverse:self.noop,fn:self.program(8,program8,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n    </ul>\n    "}function program8(depth0,data){var stack1,helper,buffer="";return buffer+='\n        <li data-resource="',(helper=helpers.id)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.id,
stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'">\n            <span class="resource-label">',(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'</span>\n            <span class="reason">(',(helper=helpers.reason)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.reason,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+")</span>\n        </li>\n        ";
}function program10(depth0,data){var helper,options,buffer="";return buffer+="\n    <p>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"The action cannot be applied, no eligible sessions found",options):helperMissing.call(depth0,"__","The action cannot be applied, no eligible sessions found",options)))+"</p>\n    "}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",functionType="function",escapeExpression=this.escapeExpression,self=this,helperMissing=helpers.helperMissing;return buffer+='<div class="bulk-action-popup">\n    <h2 class="title">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,
options={hash:{},data:data},helper?helper.call(depth0,"Action",options):helperMissing.call(depth0,"__","Action",options)))+": ",(helper=helpers.actionName)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.actionName,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</h2>\n\n    ",stack1=helpers.if.call(depth0,(stack1=depth0&&depth0.allowedResources,null==stack1||stack1===!1?stack1:stack1.length),{hash:{},inverse:self.program(10,program10,data),fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+='\n\n    <div class="form">\n        <p>\n            <label for="input-extra-time">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,
options={hash:{},data:data},helper?helper.call(depth0,"Extra time",options):helperMissing.call(depth0,"__","Extra time",options)))+':</label>\n            <input type="text" id="input-extra-time" data-control="time" value="',(helper=helpers.time)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.time,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'" maxlength="4" size="4" />\n            <label for="input-extra-time">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"minutes",options):helperMissing.call(depth0,"__","minutes",options)))+"</label>\n        </p>\n    </div>\n    <p>\n        <strong>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,
options={hash:{},data:data},helper?helper.call(depth0,"Note",options):helperMissing.call(depth0,"__","Note",options)))+":</strong>\n        <em>"+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"the already granted time will be replaced by the new value",options):helperMissing.call(depth0,"__","the already granted time will be replaced by the new value",options)))+'</em>\n    </p>\n\n    <div class="actions">\n        <div class="feedback-error small hidden">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"The extra time must be a number",options):helperMissing.call(depth0,"__","The extra time must be a number",options)))+'</div>\n        <button class="btn btn-info small action done" data-control="done">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,
options={hash:{},data:data},helper?helper.call(depth0,"OK",options):helperMissing.call(depth0,"__","OK",options)))+'</button>\n        <a href="#" class="btn action cancel" title="'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"cancel the action",options):helperMissing.call(depth0,"__","cancel the action",options)))+'" data-control="cancel">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"cancel",options):helperMissing.call(depth0,"__","cancel",options)))+"</a>\n    </div>\n\n</div>\n"})}),define("taoProctoring/component/extraTime/extraTime",["jquery","lodash","i18n","core/encoder/time","ui/component","ui/hider","taoProctoring/component/extraTime/encoder","tpl!taoProctoring/component/extraTime/extraTime","ui/modal"],function($,_,__,timeEncoder,component,hider,encodeExtraTime,extraTimeTpl){
"use strict";function extraTimeFactory(config){var initConfig=_.defaults(config||{},_defaults),timeUnit=initConfig.unit||_defaults.unit;return _.forEach(initConfig.allowedResources,function(resource){var remaining=parseFloat(resource.remaining)||0,extraTime=parseFloat(resource.extraTime),consumedTime=parseFloat(resource.consumedTime);remaining&&(resource.remainingStr=timeEncoder.encode(remaining)),resource.extraTimeStr=encodeExtraTime(extraTime,consumedTime,__("%s minutes more"),timeUnit)}),component().setTemplate(extraTimeTpl).on("render",function(){function checkInputError(){var value=$time.val().trim(),time=Number(value),error=isNaN(time)||time!==parseFloat(value);
return error?(hider.show($error),$ok.attr("disabled",!0),focus()):($ok.removeAttr("disabled"),hider.hide($error)),error}function submit(){checkInputError()||(self.trigger("ok",parseFloat($time.val())*timeUnit),$cmp.modal("close"))}function cancel(){self.trigger("cancel"),$cmp.modal("close")}function focus(){$time.focus().select()}var self=this,$cmp=this.getElement(),$time=$cmp.find('[data-control="time"]'),$error=$cmp.find(".feedback-error"),$ok=$cmp.find('[data-control="done"]');$time.val(_.reduce(initConfig.allowedResources,function(time,testTaker){return Math.max(time,testTaker&&testTaker.extraTime||0)},0)/timeUnit),$cmp.addClass("modal").on("closed.modal",function(){
self.destroy()}).on("change",$time,function(){checkInputError()}).on("keyup",function(event){13===event.keyCode?submit():checkInputError()}).on("click",".action",function(event){var $btn=$(event.target).closest(".action"),control=$btn.data("control");event.preventDefault(),"done"===control?submit():cancel()}).modal({width:800}),focus()}).on("destroy",function(){this.getElement().removeClass("modal").modal("destroy")}).init(initConfig)}var _defaults={unit:60,deniedResources:[]};return extraTimeFactory}),define("tpl!taoProctoring/templates/delivery/monitoring",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){
var stack1,helper,buffer="";return buffer+="<h1>",(helper=helpers.title)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.title,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</h1>"}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,buffer="",functionType="function",escapeExpression=this.escapeExpression,self=this;return buffer+='<div class="content">\n    ',stack1=helpers.if.call(depth0,depth0&&depth0.title,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),
buffer+='\n    <div class="panel"></div>\n    <div class="list clearfix"></div>\n</div>\n'})}),define("tpl!taoProctoring/templates/delivery/deliveryLink",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,buffer="",functionType="function";return buffer+='<span class="elipsis" title="',(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),(stack1||0===stack1)&&(buffer+=stack1),buffer+='">',
(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),(stack1||0===stack1)&&(buffer+=stack1),buffer+="</span>\n"})}),define("tpl!taoProctoring/templates/delivery/statusFilter",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var stack1,helper,buffer="";return buffer+='\n    <option value="',(helper=helpers.code)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.code,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data
}):helper),buffer+=escapeExpression(stack1)+'">',(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</option>\n    "}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,buffer="",functionType="function",escapeExpression=this.escapeExpression,self=this;return buffer+='<select name="filter[status]" class="filter status select2">\n    <option value="" selected></option>\n    ',stack1=helpers.each.call(depth0,depth0&&depth0.statuses,{hash:{},inverse:self.noop,
fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+="\n</select>"})}),define("taoProctoring/controller/Delivery/monitoring",["jquery","lodash","i18n","module","controller/app","util/url","layout/loading-bar","core/encoder/time","util/encode","ui/feedback","ui/dialog","ui/bulkActionPopup","ui/cascadingComboBox","ui/container","taoProctoring/component/proxy","taoProctoring/component/extraTime/extraTime","taoProctoring/component/extraTime/encoder","taoProctoring/helper/status","tpl!taoProctoring/templates/delivery/monitoring","tpl!taoProctoring/templates/delivery/deliveryLink","tpl!taoProctoring/templates/delivery/statusFilter","ui/datatable","jqueryui","select2"],function($,_,__,module,appController,urlHelper,loadingBar,timeEncoder,encode,feedback,dialog,bulkActionPopup,cascadingComboBox,containerFactory,proxyFactory,extraTimePopup,encodeExtraTime,_status,monitoringTpl,deliveryLinkTpl,statusFilterTpl){
"use strict";function handleOnDisconnect(err){403===err.code&&window.location.reload(!0)}function validateParams(params){return _.isPlainObject(params)&&(_.isUndefined(params.delivery)||!_.isEmpty(params.delivery))&&!_.isEmpty(params.execution)}var cssScope=".delivery-monitoring",terminateUrl=urlHelper.route("terminateExecutions","Monitor","taoProctoring"),pauseUrl=urlHelper.route("pauseExecutions","Monitor","taoProctoring"),authorizeUrl=urlHelper.route("authoriseExecutions","Monitor","taoProctoring"),extraTimeUrl=urlHelper.route("extraTime","Monitor","taoProctoring"),reportUrl=urlHelper.route("reportExecutions","Monitor","taoProctoring"),serviceUrl=urlHelper.route("monitor","Monitor","taoProctoring"),executionsUrl=urlHelper.route("deliveryExecutions","Monitor","taoProctoring"),historyUrl=urlHelper.route("index","Reporting","taoProctoring"),extraTimeUnit=60;
return loadingBar.start(),{start:function(){var dataset,extraFields,categories,timeHandlingButton,printReportButton,actionButtons,actionList,container=containerFactory().changeScope(cssScope).write(monitoringTpl()),$content=container.find(".content"),$list=container.find(".list"),pageParams=module.config(),deliveryId=pageParams.delivery,context=pageParams.context,defaultTag=pageParams.defaultTag,defaultAvailableLabel=__("Current sessions"),tools=[],model=[],highlightRows=[],serviceParams={},sessionsHistoryUrl=historyUrl;appController.on("change.deliveryMonitoring",function(){appController.off(".deliveryMonitoring"),container.destroy()}),proxyFactory("ajax").init({
actions:{read:serviceUrl,authorize:{url:authorizeUrl,validate:validateParams},pause:{url:pauseUrl,validate:validateParams},terminate:{url:terminateUrl,validate:validateParams},report:{url:reportUrl,validate:validateParams},extraTime:{url:extraTimeUrl,validate:validateParams}}}).then(function(proxyExecutions){function request(action,selection,data,message){var params;selection&&selection.length&&(loadingBar.start(),params=_.merge({execution:selection},data),deliveryId&&(params.delivery=deliveryId),proxyExecutions.action(action,params).then(function(){message&&feedback().success(message),$list.datatable("refresh")}).catch(function(err){var unprocessed,responseData,messageContext="";
err.response?(responseData=err.response.data,unprocessed=_.map(responseData.unprocessed,function(id){var execution=getExecutionData(id);if(execution)return __("Session %s - %s has not been processed",execution.delivery,execution.start_time)}),unprocessed.length&&(messageContext+="<br>"+unprocessed.join("<br>")),responseData.error&&(messageContext+="<br>"+encode.html(responseData.error))):handleOnDisconnect(err),feedback().error(__("Something went wrong ...")+"<br>"+messageContext,{encodeHtml:!1})}).then(function(){loadingBar.stop()}))}function authorize(selection){execBulkAction("authorize",__("Authorize Session"),selection,function(sel,reason){request("authorize",sel,{
reason:reason},__("Sessions authorized"))})}function pause(selection){execBulkAction("pause",__("Pause Session"),selection,function(sel,reason){request("pause",sel,{reason:reason},__("Sessions paused"))})}function terminate(selection){execBulkAction("terminate",__("Terminate Session"),selection,function(sel,reason){request("terminate",sel,{reason:reason},__("Sessions terminated"))})}function report(selection){execBulkAction("report",__("Report Irregularity"),selection,function(sel,reason){request("report",sel,{reason:reason},__("Sessions reported"))})}function print(selection,type){execBulkAction("print",__("Print Score"),selection,function(sel){window.open(urlHelper.route(type,"Reporting","taoProctoring",{
id:sel}),"printReport"+JSON.stringify(sel))})}function terminateAndIrregularity(selection){dialog({message:__("Please, make your selection"),autoRender:!0,autoDestroy:!0,buttons:[{id:"terminate",type:"error",label:__("Terminate session"),icon:"stop",close:!0,action:function(){terminate(selection)}},{id:"irregularity",type:"info",label:__("Report irregularity"),icon:"delivery-small",close:!0,action:function(){report(selection)}}]})}function showHistory(selection){var monitoringRoute=window.location+"",urlParams={session:selection};deliveryId&&(urlParams.delivery=deliveryId),appController.getRouter().redirect(urlHelper.build(sessionsHistoryUrl,urlParams)).then(function(){
appController.trigger("set-referrer",monitoringRoute)})}function printReport(selection){print(selection,"printReport")}function printResults(selection){print(selection,"printRubric")}function timeHandling(selection){var _selection=_.isArray(selection)?selection:[selection],config=_.merge(listSessions("time",_selection),{renderTo:$content,actionName:__("Grant Extra Time"),unit:extraTimeUnit});extraTimePopup(config).on("ok",function(time){request("extraTime",_selection,{time:time},__("Extra time granted"))})}function canDo(what,state){var status;return!(!state||!state.status)&&(status=_status.getStatusByCode(state.status),status&&status.can[what]===!0)}function verifyDelivery(testTakerData,actionName){
var deliveryName,formatted,status;return deliveryName=_.isObject(testTakerData.delivery)?testTakerData.delivery.label:testTakerData.delivery,formatted={id:testTakerData.id,label:deliveryName+" ["+testTakerData.start_time+"] "+testTakerData.test_taker_first_name+" "+testTakerData.test_taker_last_name},status=_status.getStatusByCode(testTakerData.state.status),status&&(formatted.allowed=status.can[actionName]===!0,formatted.allowed||(formatted.reason=status.can[actionName])),testTakerData.timer&&(formatted.extraTime=testTakerData.timer.extraTime,formatted.consumedTime=testTakerData.timer.consumedExtraTime,formatted.remaining_time=testTakerData.timer.remaining_time),
formatted}function getExecutionData(uri){return _.find(dataset.data,{id:uri})}function listSessions(actionName,selection){var allowedDeliveries=[],forbiddenDeliveries=[];return _.each(selection,function(uri){var checkedDelivery,testTakerData=getExecutionData(uri);testTakerData&&(checkedDelivery=verifyDelivery(testTakerData,actionName),checkedDelivery.allowed?allowedDeliveries.push(checkedDelivery):forbiddenDeliveries.push(checkedDelivery))}),{resourceType:"session",allowedResources:allowedDeliveries,deniedResources:forbiddenDeliveries}}function execBulkAction(actionName,actionTitle,selection,cb){var _selection=_.isArray(selection)?selection:[selection],askForReason=categories[actionName]&&categories[actionName].categoriesDefinitions&&categories[actionName].categoriesDefinitions.length,config=_.merge(listSessions(actionName,_selection),{
renderTo:$content,actionName:actionTitle,reason:askForReason,reasonRequired:!0,categoriesSelector:cascadingComboBox(categories[actionName]||{})});config.allowedResources.length?bulkActionPopup(config).on("ok",function(reason){_.isFunction(cb)&&cb(_selection,reason)}):_selection.length>1?feedback().warning(__("No report available for these test sessions")):feedback().warning(__("No report available for this test session"))}function buildStatusFilter(){return statusFilterTpl({statuses:_status.getStatuses()})}function setTagUsage(applyTags){var $filter;defaultTag&&($list.find(".tag").length||($filter=$('<span class="filter"><input type="hidden" name="tag" class="tag" value="'+applyTags+'"/></span>'),
$filter.appendTo($list)),$list.find(".tag").val(applyTags),$list.data("applytags",applyTags),applyTags?$list.find(".action-bar").children(".tool-tag").hide():$list.find(".action-bar").children(".tool-notag").hide())}function getTagsUsage(){return $list.data("applytags")}function setInitialFilters(){var now=new Date,nowStr=now.getFullYear()+"/"+("0"+(now.getMonth()+1)).slice(-2)+"/"+("0"+now.getDate()).slice(-2);$("#start_time_filter").val(nowStr+" - "+nowStr),defaultTag&&setTagUsage(!0),$list.datatable("filter")}function statusFilterHandler($el){$el.select2({dropdownAutoWidth:!0,placeholder:__("Filter"),minimumResultsForSearch:1/0,allowClear:!0})}return deliveryId&&(serviceParams.delivery=deliveryId),
context&&(serviceParams.context=context),proxyExecutions.read(serviceParams).then(function(data){dataset=data.set,extraFields=data.extrafields,categories=data.categories,deliveryId=data.delivery||deliveryId,context=data.context||context,timeHandlingButton=data.timeHandling,printReportButton=data.printReportButton,sessionsHistoryUrl=data.historyUrl||historyUrl,deliveryId&&(serviceParams.delivery=deliveryId),context&&(serviceParams.context=context),tools.push({id:"refresh",icon:"reset",title:__("Refresh the page"),label:__("Refresh"),action:function(){$list.datatable("refresh")}}),defaultTag&&(tools.push({id:"notag",icon:"filter",css:"btn-warning",label:__("Remove default tag filtering"),
title:__("Remove default tag filtering"),action:function(){setTagUsage(!1),$list.datatable("filter")}}),tools.push({id:"tag",icon:"filter",title:__("Apply default tag"),label:__("Apply default tag"),action:function(){setTagUsage(!0),$list.datatable("filter")}})),tools.push({id:"authorize",icon:"play",title:__("Authorize sessions"),label:__("Authorize"),massAction:!0,action:authorize}),tools.push({id:"pause",icon:"pause",title:__("Pause sessions"),label:__("Pause"),massAction:!0,action:pause}),tools.push({id:"terminate",icon:"stop",title:__("Terminate sessions"),label:__("Terminate"),massAction:!0,action:terminate}),tools.push({id:"irregularity",icon:"delivery-small",
title:__("Report irregularities"),label:__("Report"),massAction:!0,action:report}),tools.push({id:"history",icon:"history",title:__("Show the detailed session history"),label:__("History"),massAction:!0,action:showHistory}),tools.push({id:"printRubric",title:__("Print the score report"),icon:"print",label:__("Print Score"),massAction:!0,action:printResults}),printReportButton&&tools.push({id:"printReport",title:__("Print the assessment results"),icon:"result",label:__("Print Results"),massAction:!0,action:printReport}),timeHandlingButton&&tools.push({id:"timeHandling",title:__("Session time handling"),icon:"time",label:__("Time"),massAction:!0,action:timeHandling
}),model.push({id:"deliveryLabel",label:__("Session"),sortable:!0,transform:function(value,row){var delivery=row&&row.delivery;return delivery&&(value=deliveryLinkTpl(delivery)),value}}),model.push({id:"test_taker_first_name",label:__("First name"),sortable:!0,transform:function(value,row){return row&&row.testTaker&&row.testTaker.test_taker_first_name||""}}),model.push({id:"test_taker_last_name",label:__("Last name"),sortable:!0,transform:function(value,row){return row&&row.testTaker&&row.testTaker.test_taker_last_name||""}}),_.each(extraFields,function(extraField){model.push({id:extraField.id,label:extraField.label,sortable:!0,transform:function(value,row){return row&&row.extraFields&&row.extraFields[extraField.id]||"";
}})}),model.push({id:"start_time",sortable:!0,label:__("Started at"),filterable:!0,customFilter:{template:'<input type="text" id="start_time_filter" name="filter[start_time]"/><button class="icon-find js-start_time_filter_button" type="button"></button>',callback:function($el){$el.datepicker({dateFormat:"yy/mm/dd",onSelect:function(selectedDate){$(this).data().datepicker.first?(selectedDate>$(this).data().datepicker.first?$(this).val($(this).data().datepicker.first+" - "+selectedDate):$(this).val(selectedDate+" - "+$(this).data().datepicker.first),$(this).data().datepicker.inline=!1,$(".js-start_time_filter_button").trigger("click")):($(this).data().datepicker.inline=!0,
$(this).data().datepicker.first=selectedDate)},onClose:function(){delete $(this).data().datepicker.first,$(this).data().datepicker.inline=!1}})}}}),model.push({id:"status",label:__("Status"),sortable:!0,filterable:!0,customFilter:{template:buildStatusFilter(),callback:statusFilterHandler},transform:function(value,row){var status,result="";return row&&row.state&&row.state.status&&(status=_status.getStatusByCode(row.state.status),status&&(result=status.label,"INPROGRESS"===row.state.status&&(result=status.label),"Awaiting"===result&&highlightRows.push(row.id))),result}}),model.push({id:"authorizeCl",label:__("Authorize"),type:"actions",actions:[{id:"authorize",
icon:"play",title:__("Authorize session"),disabled:function(){return!canDo("authorize",this.state)},action:authorize}]}),model.push({id:"pauseCl",label:__("Pause"),type:"actions",actions:[{id:"pause",icon:"pause",title:__("Pause session"),disabled:function(){return!canDo("pause",this.state)},action:pause}]}),model.push({id:"remaining_time",sortable:!0,label:__("Remaining"),transform:function(value,row){var timer=_.isObject(row.timer)?row.timer:{},refinedValue=timer.remaining_time,remaining=parseInt(refinedValue,10);return(remaining||_.isFinite(remaining))&&(refinedValue=remaining?timeEncoder.encode(remaining):"",refinedValue+=encodeExtraTime(timer.extraTime,timer.consumedExtraTime,__("%s min"),extraTimeUnit)),
refinedValue}}),timeHandlingButton&&model.push({id:"extraTime",label:__("Extra Time"),type:"actions",actions:[{id:"timeHandling",title:__("Session time handling"),icon:"time",action:timeHandling,hidden:function(){return!canDo("time",this.state)}}]}),model.push({id:"last_connect",sortable:!0,label:__("Connectivity"),transform:function(value,row){return row.state.status===_status.STATUS_INPROGRESS?__(row.online?"online":"offline"):""}}),model.push({id:"progress",label:__("Progress"),transform:function(value,row){return row&&row.state&&row.state.progress||""}}),actionList=[{id:"terminateAndIrregularity",icon:"delivery-small",title:__("Terminate and irregularity"),
action:terminateAndIrregularity},{id:"history",icon:"history",title:__("Show the detailed session history"),action:showHistory},{id:"printRubric",title:__("Print the Score Report"),icon:"print",action:printResults}],printReportButton&&actionList.push({id:"printReport",title:__("Print the assessment results"),icon:"result",action:printReport}),model.push({id:"administrationCl",label:__("Administration"),type:"actions",actions:actionList}),$list.on("query.datatable",function(){loadingBar.start(),highlightRows=[]}).on("load.datatable",function(e,newDataset){var applyTags;dataset=newDataset,actionButtons=_({authorize:$list.find(".action-bar").children(".tool-authorise"),
pause:$list.find(".action-bar").children(".tool-pause"),terminate:$list.find(".action-bar").children(".tool-terminate"),report:$list.find(".action-bar").children(".tool-irregularity")}),defaultTag&&(applyTags=$list.data("applytags"),applyTags=!!_.isUndefined(applyTags)||applyTags,setTagUsage(applyTags)),highlightRows.length&&_.forEach(highlightRows,function(v){$list.datatable("highlightRow",v)}),loadingBar.stop()}).on("select.datatable",function(){actionButtons.each(function($btn){$btn.hide()}),_($list.datatable("selection")).map(function(uri){var row=getExecutionData(uri);return row.state.status}).uniq().each(function(statusCode){var status=_status.getStatusByCode(statusCode);
actionButtons.forIn(function($btn,action){status&&status.can[action]===!0&&$btn.show()})})}).datatable({url:urlHelper.build(executionsUrl,serviceParams),status:{empty:__("No sessions"),available:function(){return getTagsUsage()?__("Groups: %s. %s",defaultTag.split(",").join(", "),defaultAvailableLabel):defaultAvailableLabel},loading:__("Loading")},filterStrategy:"multiple",filterSelector:"select, input:not(.select2-input, .select2-focusser)",filter:!0,tools:tools,model:model,selectable:!0,sortorder:"desc",sortby:"start_time"},dataset),setInitialFilters()})}).catch(function(err){handleOnDisconnect(err),appController.onError(err),loadingBar.stop()})}}}),define("taoProctoring/controller/Delivery/testTakers",["jquery","i18n","helpers","layout/loading-bar","util/encode","ui/feedback","taoProctoring/component/breadcrumbs","ui/datatable"],function($,__,helpers,loadingBar,encode,feedback,breadcrumbsFactory){
"use strict";var cssScope=".delivery-testtakers";loadingBar.start();var proctorDeliveryAssignCtlr={start:function(){var $container=$(cssScope),$list=$container.find(".list"),crumbs=$container.data("breadcrumbs"),dataset=$container.data("set"),deliveryId=$container.data("delivery"),testCenterId=$container.data("testcenter"),serviceUrl=helpers._url("availableTestTakers","Delivery","taoProctoring",{delivery:deliveryId,testCenter:testCenterId}),assignUrl=helpers._url("assignTestTakers","Delivery","taoProctoring",{delivery:deliveryId,testCenter:testCenterId}),managerUrl=helpers._url("manage","Delivery","taoProctoring",{delivery:deliveryId,testCenter:testCenterId}),assign=(breadcrumbsFactory($container,crumbs),
function(selection){selection&&selection.length&&(loadingBar.start(),$.ajax({url:assignUrl,data:{testtaker:selection},dataType:"json",type:"POST",error:function(){loadingBar.stop()}}).done(function(response){loadingBar.stop(),response&&response.success?(feedback().success(__("Test takers have been added")),window.location.href=managerUrl):feedback().error(__("Something went wrong ...")+"<br>"+encode.html(response.error),{encodeHtml:!1})}))});$list.on("query.datatable",function(){loadingBar.start()}).on("load.datatable",function(event,response){loadingBar.stop()}).datatable({url:serviceUrl,status:{empty:__("No available test takers to assign"),available:__("Available test takers"),
loading:__("Loading")},tools:[{id:"back",icon:"left",title:__("Return to the session manager"),label:__("Back"),action:function(){window.location.href=managerUrl}},{id:"refresh",icon:"reset",title:__("Refresh the page"),label:__("Refresh"),action:function(){$list.datatable("refresh")}},{id:"assign",icon:"add",title:__("Assign the selected test takers to the session"),label:__("Assign the selected test takers"),massAction:!0,action:function(selection){assign(selection)}}],actions:[{id:"assign",icon:"add",title:__("Assign the test taker to the session"),action:function(id){assign([id])}}],selectable:!0,model:[{id:"firstname",label:__("First name")},{id:"lastname",
label:__("Last name")},{id:"identifier",label:__("Identifier")}]},dataset)}};return proctorDeliveryAssignCtlr}),define("taoQtiTest/testRunner/resumingStrategy/keepAfterResume",[],function(){"use strict";var sessionStateFactory=function(options){function _start(){if(null!==_interval)throw new TypeError("Tracking is already started");_interval=setInterval(function(){setLocalStorageData(getLocalStorageData()+_accuracy)},_accuracy)}function _stop(){clearInterval(_interval),_interval=null}function _reset(){_stop(),clearLocalStorage()}function _init(){_accuracy=options&&options.accuracy||1e3}function setLocalStorageData(val){window.localStorage.setItem(_storageKey,val);
}function getLocalStorageData(){var data=window.localStorage.getItem(_storageKey),result=JSON.parse(data)||0;return result}function clearLocalStorage(){window.localStorage.removeItem(_storageKey)}var _accuracy,_storageKey="sessionState_active_for",_interval=null,sessionState={reset:function(){_reset()},restart:function(){_reset(),_start()},getDuration:function(){return getLocalStorageData()}};return _init(),sessionState};return sessionStateFactory}),define("tpl!taoProctoring/templates/deliveryServer/authorizationSuccess",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),
data=data||{};var stack1,helper,buffer="",functionType="function",escapeExpression=this.escapeExpression;return buffer+='<span class="success-message">',(helper=helpers.message)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.message,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'<span class="icon-result-ok"></span></span>'})}),define("tpl!taoProctoring/templates/deliveryServer/authorizationListBoxActions",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var helper,options,buffer="";return buffer+='\n    <span class="action cancel js-cancel">\n        <span class="icon-stop"></span>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,
options={hash:{},data:data},helper?helper.call(depth0,"Cancel",options):helperMissing.call(depth0,"__","Cancel",options)))+"\n    </span>\n    "}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression,self=this,functionType="function";return buffer+='<span class="listbox-actions">\n    ',stack1=helpers.if.call(depth0,depth0&&depth0.cancelable,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+='\n    <span class="action play js-proceed" data-delivery="',
(helper=helpers.id)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.id,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'">\n        <span class="icon-play"></span>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Proceed",options):helperMissing.call(depth0,"__","Proceed",options)))+"\n    </span>\n</span>"})}),define("taoProctoring/controller/DeliveryServer/awaiting",["lodash","jquery","i18n","helpers","layout/loading-bar","ui/listbox","ui/dialog/alert","core/polling","taoQtiTest/testRunner/resumingStrategy/keepAfterResume","util/url","ui/dialog/confirm","tpl!taoProctoring/templates/deliveryServer/authorizationSuccess","tpl!taoProctoring/templates/deliveryServer/authorizationListBoxActions"],function(_,$,__,helpers,loadingBar,listBox,dialogAlert,polling,keepAfterResume,url,dialogConfirm,authSuccessTpl,listBoxActionsTpl){
"use strict";var refreshPolling=1e4,cssScope=".awaiting-authorization",awaitingAuthorizationCtlr={start:function(config){function authorized(){loadingBar.stop(),$container.addClass("authorization-granted").removeClass("authorization-in-progress"),$content.html(authSuccessTpl({message:__("Authorized, you may proceed")}))}function exit(){window.location.href=config.returnUrl}var $container=$(cssScope),isAuthorizedUrl=helpers._url("isAuthorized","DeliveryServer","taoProctoring",{deliveryExecution:config.deliveryExecution}),runDeliveryUrl=config.runDeliveryUrl,boxes=[{id:"goToDelivery",label:config.deliveryLabel,url:runDeliveryUrl,content:__("Please wait, authorization in process ..."),
html:listBoxActionsTpl({id:config.deliveryExecution,cancelable:config.cancelable})}],$content=(listBox({title:__(config.deliveryInit?"Start Test":"Resume Test"),textEmpty:"",textNumber:"",textLoading:"",renderTo:$container,list:boxes,width:12}),$container.find(".listbox .content"));keepAfterResume().reset(),loadingBar.start(!1),$container.on("click",".js-cancel",function(e){e.stopPropagation(),e.preventDefault(),dialogConfirm(__("Are you sure you want to end the test?"),function(){window.location.href=config.cancelUrl})}),$container.on("click",".js-proceed",function(e){$container.hasClass("authorization-in-progress")&&(e.stopPropagation(),e.preventDefault())}),
polling({action:function(){var async=this.async();$.get(isAuthorizedUrl,function(result){var stop=!1;result.success?result.authorized&&(stop=!0,authorized()):(stop=!0,result.message?dialogAlert(result.message,exit):exit()),stop?async.reject():async.resolve()})},interval:refreshPolling,autoStart:!0})}};return awaitingAuthorizationCtlr}),define("taoProctoring/controller/Irregularity/index",["lodash","jquery","i18n","ui/feedback","layout/loading-bar","helpers","jquery.fileDownload"],function(_,$,__,feedback,loadingBar,helpers){"use strict";var IrregularityCtlr={start:function(){var $form=$("#export-form");$form.on("submit",function(e){e.stopPropagation(),e.preventDefault(),
loadingBar.start();var self=$(this),uri=$('[name="uri"]',self).val(),from=$('[name="from"]',self).val(),to=$('[name="to"]',self).val(),params={uri:uri,from:from,to:to},exportUrl=helpers._url("exportIrregularities","Irregularity","taoProctoring",params);$.fileDownload(exportUrl,{successCallback:function(){loadingBar.stop()},failCallback:function(jqXHR){loadingBar.stop();var response=$.parseJSON($(jqXHR).text());response&&feedback().error(new Error(response.message))}})})}};return IrregularityCtlr}),define("tpl!taoProctoring/component/dateRange/form",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],
helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",helperMissing=helpers.helperMissing,escapeExpression=this.escapeExpression,functionType="function";return buffer+='<form class="daterange">\n    <label>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"From",options):helperMissing.call(depth0,"__","From",options)))+'</label><input type="text" name="periodStart" value="',(helper=helpers.start)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.start,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'"/>\n    <label>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,
options={hash:{},data:data},helper?helper.call(depth0,"to",options):helperMissing.call(depth0,"__","to",options)))+'</label><input type="text" name="periodEnd" value="',(helper=helpers.end)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.end,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'"/>\n    <button class="small info" data-control="filter"><span class="icon icon-filter"></span>'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Filter",options):helperMissing.call(depth0,"__","Filter",options)))+"</button>\n</form>";
})}),define("taoProctoring/component/dateRange",["jquery","lodash","ui/component","tpl!taoProctoring/component/dateRange/form","jquery.timePicker"],function($,_,component,formTpl){"use strict";function dateRangeFactory(config){var initConfig=_.defaults(config||{},_defaults),periodStart=initConfig.start||"",periodEnd=initConfig.end||"",dateRange={getStart:function(){return periodStart},getEnd:function(){return periodEnd}};return initConfig.start=periodStart,initConfig.end=periodEnd,component(dateRange).setTemplate(formTpl).on("render",function(){var self=this,$form=this.getElement(),$periodStart=$form.find("input[name=periodStart]"),$periodEnd=$form.find("input[name=periodEnd]"),$filterBtn=$form.find('[data-control="filter"]');
$periodStart.datepicker({dateFormat:initConfig.dateFormat,autoSize:!0}).change(function(){periodStart=$periodStart.val(),$periodEnd.datepicker("option","minDate",periodStart),self.trigger("change","start",periodStart)}),$periodEnd.datepicker({dateFormat:initConfig.dateFormat,autoSize:!0}).change(function(){periodEnd=$periodEnd.val(),$periodStart.datepicker("option","maxDate",periodEnd),self.trigger("change","end",periodEnd)}),$filterBtn.on("click",function(event){event.preventDefault(),periodStart=$periodStart.val(),periodEnd=$periodEnd.val(),self.trigger("submit")})}).init(initConfig)}var _defaults={dateFormat:"yy-mm-dd"};return dateRangeFactory}),define("taoProctoring/component/history/historyTable",["jquery","lodash","i18n","ui/component","ui/datatable"],function($,_,__,component){
"use strict";function renderDetails(details){return _.isArray(details)&&(details=details.join("<br />")),details}function historyTableFactory(config,data){var initConfig=_.defaults(config||{},_defaults),historyTable={refresh:function(params){var $element;this.is("rendered")?($element=this.getElement(),params&&$element.datatable("options",{params:params}),$element.datatable("refresh")):params&&(initConfig.params=_.merge(initConfig.params,params))}};return component(historyTable).on("render",function(){var self=this,tools=[{id:"refresh",icon:"reset",title:__("Refresh the page"),label:__("Refresh"),action:function(){self.refresh()}}];this.getElement().on("query.datatable",function(){
self.trigger("loading")}).on("load.datatable",function(){self.trigger("loaded")}).datatable({url:initConfig.service,params:initConfig.params,sortby:initConfig.sortBy,sortorder:initConfig.sortOrder,status:{empty:__("No history to display!"),available:__("Available history"),loading:__("Loading")},selectable:!(!initConfig.tools||!_.find(initConfig.tools,{massAction:!0})),tools:tools.concat(initConfig.tools||[]),model:[{id:"date",label:__("Date"),sortable:!0},{id:"role",label:__("Role"),sortable:!0},{id:"actor",label:__("Actor"),sortable:!0},{id:"event",label:__("Event"),sortable:!0},{id:"details",label:__("Details"),transform:renderDetails},{id:"context",label:__("Context"),
transform:renderDetails}]},data)}).init(initConfig)}var _defaults={sortBy:"timestamp",sortOrder:"desc"};return historyTableFactory}),define("tpl!taoProctoring/templates/reporting/index",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var stack1,helper,buffer="";return buffer+="<h1>",(helper=helpers.title)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.title,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</h1>"}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),
data=data||{};var stack1,buffer="",functionType="function",escapeExpression=this.escapeExpression,self=this;return buffer+='<div class="content">\n    ',stack1=helpers.if.call(depth0,depth0&&depth0.title,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+='\n    <div class="panel"></div>\n    <div class="list clearfix"></div>\n</div>\n'})}),define("taoProctoring/controller/Reporting/history",["i18n","util/url","controller/app","layout/loading-bar","ui/container","ui/button","util/encode","taoProctoring/component/proxy","taoProctoring/component/dateRange","taoProctoring/component/history/historyTable","tpl!taoProctoring/templates/reporting/index","ui/datatable"],function(__,urlHelper,appController,loadingBar,containerFactory,buttonFactory,encode,proxyFactory,dateRangeFactory,historyTableFactory,indexTpl){
"use strict";function handleOnDisconnect(err){403===err.code&&window.location.reload(!0)}var cssScope=".session-history",serviceUrl=urlHelper.route("sessionHistory","Reporting","taoProctoring"),sessionsUrl=urlHelper.route("history","Reporting","taoProctoring");return loadingBar.start(),{start:function(){var container=containerFactory().changeScope(cssScope).write(indexTpl()),currentRoute=urlHelper.parse(window.location.href),deliveryId=currentRoute.query.delivery&&decodeURIComponent(currentRoute.query.delivery),sessions=decodeURIComponent(currentRoute.query.session).split(","),monitoringUrl=currentRoute.query.monitoring&&decodeURIComponent(currentRoute.query.monitoring);
appController.on("set-referrer.history",function(route){monitoringUrl=route}).on("change.history",function(){appController.off(".history"),container.destroy()}),proxyFactory("ajax").init({actions:{read:serviceUrl}}).then(function(proxyService){return proxyService.read({delivery:deliveryId,session:sessions}).then(function(data){var detailedHistory=data.detailedHistory,historyTable=historyTableFactory({tools:[{id:"show-detailed-report",icon:"insert-horizontal-line",title:__("Show detailed session history messages"),label:__("Show detailed report"),action:function(){var tool=historyTable.config.tools.find(function(val){return"show-detailed-report"===val.id});historyTable.config.params.detailed=detailedHistory=!detailedHistory,
tool.label=__(detailedHistory?"Show brief report":"Show detailed report"),historyTable.refresh()}}],params:{detailed:detailedHistory,delivery:deliveryId,session:sessions},service:sessionsUrl,sortBy:data.sortBy,sortOrder:data.sortOrder},data.set).on("loading",function(){loadingBar.start()}).on("loaded",function(){loadingBar.stop()}).render(container.find(".list"));data.monitoringUrl&&(monitoringUrl=data.monitoringUrl),dateRangeFactory({start:data.periodStart,end:data.periodEnd,renderTo:container.find(".panel")}).on("change submit",function(){historyTable.refresh({periodStart:this.getStart(),periodEnd:this.getEnd()})}),buttonFactory({id:"back",type:"info",label:__("Back to sessions"),
cls:"back-button",renderTo:container.find(".panel")}).on("click",function(){monitoringUrl?appController.getRouter().redirect(monitoringUrl):history.go(-1)})})}).catch(function(err){handleOnDisconnect(err),appController.onError(err),loadingBar.stop()})}}}),define("taoProctoring/controller/Tools/pauseActiveExecutions",["jquery","i18n","helpers","util/url","ui/feedback","ui/cascadingComboBox","ui/bulkActionPopup"],function($,__,helpers,url,feedback,cascadingComboBox,bulkActionPopup){"use strict";function doPause(reason){$.ajax({type:"POST",data:{reason:reason},url:url.route("pauseActiveExecutions","Tools","taoProctoring"),dataType:"json",success:function(data){helpers.loaded(),
data.success?feedback().success(data.message):feedback().error(data.message)}})}var $container=$(".js-pause-active-executions-container"),categories=$container.data("reasoncategories"),msg=__("Warning, you are about to pause all in progress tests. All test takers will be paused on or before the next heartbeat. Please provide a reason for this action.");return{start:function(){$(".js-pause").on("click",function(){var config;config={renderTo:$container,actionName:msg,reason:!0,allowedResources:[],reasonRequired:!0,categoriesSelector:cascadingComboBox(categories.pause)},bulkActionPopup(config).on("ok",function(reason){doPause(reason)})})}}}),define("taoProctoring/controller/app",["lodash","controller/app","core/dataProvider/request","ui/container","ui/breadcrumbs","util/url"],function(_,appController,request,containerFactory,breadcrumbsFactory,urlHelper){
"use strict";function getRoutes(route){var routes=[],parsed=urlHelper.parse(route);return _.forEach(knownRoutes,function(knownRoute){var url=urlHelper.parse(knownRoute.url),params={};return parsed.path===url.path?(routes.push(route),!1):(_.forEach(knownRoute.params,function(param){parsed.query[param]&&(params[param]=decodeURIComponent(parsed.query[param]))}),void routes.push(urlHelper.build(knownRoute.url,params)))}),routes}var breadcrumbsUrl=urlHelper.route("load","Breadcrumbs","tao"),indexUrl=urlHelper.route("index","DeliverySelection","taoProctoring"),monitorUrl=urlHelper.route("index","Monitor","taoProctoring"),historyUrl=urlHelper.route("index","Reporting","taoProctoring"),knownRoutes=[{
url:indexUrl,params:[]},{url:monitorUrl,params:["delivery"]},{url:historyUrl,params:["delivery","session"]}];return _.defaults({start:function(){var toolbox=containerFactory(".header"),breadcrumbs=breadcrumbsFactory({renderTo:toolbox.getElement(),replace:!0,cls:"action-bar horizontal-action-bar"});appController.on("change.breadcrumbs",function(route){var routes=getRoutes(route);request(breadcrumbsUrl,{route:routes},"POST").then(function(data){breadcrumbs.update(data)}).catch(function(err){appController.onError(err)})}).apply("a",toolbox.getElement()).start()}},appController)});
//# sourceMappingURL=controllers.min.js.map